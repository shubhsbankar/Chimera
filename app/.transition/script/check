print("Running Dofus check script...")

//Activating the correct components according to the lang of the updater
USER_LANG=api.env("USER_LANG")
COMPONENTS_MAPPING = [
    { lang: "de", component: "de" },
    { lang: "en", component: "en" },
    { lang: "es", component: "es" },
    { lang: "fr", component: "fr" },
    { lang: "it", component: "it" },
    { lang: "pt", component: "pt" },
    { lang: "ja", component: "ja" },
    { lang: "ru", component: "ru" }
];

available_components = api.components()
for (var i=0,len=COMPONENTS_MAPPING.length; i<len; i++) {
    component = COMPONENTS_MAPPING[i]
    expectedActivationStatus = (component.lang == USER_LANG);
    for (var i=0,len=available_components.length; i<len; i++) {
        c = available_components[i]
        if(c.name == component.component && c.activated != expectedActivationStatus) {
            FORCE_UPDATE=true
            print("FORCING UPDATE : need lang component " + c.name )
        }
    }
}

trads_package_instruction = {
    "fr":"Merci de suivre la procédure d'installation de \"$PACKAGE\"",
    "en":"Please follow the instruction to install $PACKAGE",
    "de":"Bitte befolgt die Anleitung zum Installieren von $PACKAGE",
    "es":"Sigue el procedimiento de instalación de $PACKAGE",
    "it":"Segui la procedura di installazione di $PACKAGE",
    "pt":"Favor seguir o procedimento de instalação de $PACKAGE",
    "ru":"Пожалуйста, следуйте процедуре установки $PACKAGE",
    "ja":"$PACKAGEインストール手順に従ってください。"
}

function tr(map) {
    lang = api.env("USER_LANG")
    if(api.env("USER_LANG") in map )
        return map[lang]
    if("en" in map)
        return map["en"]
    if("fr" in map)
        return map["fr"]
}

//Checking Wine is correctly installed
WINE_NOT_INSTALLED=false
print("Checking Wine installation...")
if(api.osname == "linux") {
	WINE_NOT_INSTALLED = api.execute(["which", "wine"]) != 0
}

if(WINE_NOT_INSTALLED) {
    print("Wine still not installed")
    updater.displayError(tr(trads_package_instruction).replace("$PACKAGE", "Wine (https://www.winehq.org/)"))
}